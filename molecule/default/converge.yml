---
- name: Converge
  hosts: all
  become_method: su
  tasks:
    - name: "update dnf"
      dnf:
        name: "*"
        state: "latest"
      become: true

    - name: "install required dependencies"
      package:
        name:  ["unzip","which", "java-21-openjdk", "java-21-openjdk-headless"]
      become: true

    - name: "Include fuseki"
      import_role:
        name: "oyvindlgjesdal.fuseki"
      vars:
        maven_repo: "https://repository.apache.org/content/repositories/orgapachejena-1069"
        fuseki_version: "5.5.0"
        fuseki_checksum: "bfbf59eac731b71bcf8e148f2abeda9b4adca215639eef3bba61243b308572b23a9a70a43c1483247f9894bfb23d69b59e0e64e1da47cb3cfc592aa979084d5c"
        jena_checksum: "f9ae68a748e642c6a8175ee25afdfa37ce057ed37e7caf279a8a46ad93284bea808cf14d96bf30b6e4e6a4ddaf30cf5ee9d441f48a9a3d3c9e647a9b71645e0c"
        fuseki_staging: true
        fuseki_shiro_url_rules: |
            /$/status  = authcBasic,user[admin]
        fuseki_shiro_users:   
        - name: "admin"
          password_stanza: "$shiro2$argon2id$v=19$t=1,m=65536,p=4$Wr/2XKxWeYZt8JE5HCONQw$yev4bLiGzbeIZ8qDWrIY7J2msL2vRO/aYksb4RMeX7Y"
        fuseki_workspace: "/tmp/"
        service_enhancer_url: "https://github.com/OyvindLGjesdal/jena/releases/download/service-enhancer-shaded/jena-serviceenhancer-5.2.0-SNAPSHOT.jar"
        #
        fuseki_modules:
                #
        # sis-embedded-data packaged with shading enabled
        - "https://github.com/OyvindLGjesdal/jena/releases/download/service-enhancer-shaded/jena-sis-nonfree-1.0.jar"

                #
                # - "https://repo1.maven.org/maven2/org/apache/sis/non-free/sis-embedded-data/1.4/sis-embedded-data-1.4.jar"
        fuseki_configurations:
        - name: "test-db_all"
          read_write: true
          write_timeout: "70000,200000"
          union_default_graph: true
          lucene: true
          geosparql: true

          service_enhancer: true
          luceneStoreValues: true
          prefix: |
            @prefix ex: <http://example.org/Schema#> .
          entity_map: |
            text:defaultField     "label" ;
            text:entityField      "uri" ;
            text:uidField         "uid" ;
            text:langField        "lang" ;
            text:graphField       "graph" ;
            text:map (
              [ text:field "label" ;

               text:predicate ex:name ] )
     
